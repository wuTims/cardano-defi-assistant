# Checkpoint: Balance Discrepancy Investigation & System Architecture Insights
**Date**: 2025-08-14 07:10 UTC  
**Session Topic**: Discovered blockchain immutability principles for optimal sync strategy, fixed transaction parsing, identified 7.23 ADA discrepancy source

## 1. Session Summary

### What Was Accomplished
- **Fixed logger.debug error** - Added missing debug method to Logger class
- **Fixed transaction API data transformation** - Properly handled snake_case to camelCase conversion with strong TypeScript types
- **Identified balance discrepancy root cause** - Found 7.23 ADA difference between Blockfrost (5021.18) and our calculation (5013.95)
- **Verified transaction parsing accuracy** - Individual transaction net change calculations are correct
- **Discovered missing staking withdrawals** - BlockfrostService wasn't fetching withdrawal data
- **Established blockchain immutability principle** - Transactions never change, enabling optimized incremental sync

### Key Insights
- Blockchain is immutable - once synced, transactions NEVER change
- Balance should be cached and incrementally updated, not recalculated
- The 7.23 ADA discrepancy is NOT from fees or missing transactions
- We have all 72 transactions but missing withdrawal amounts

## 2. Implementation Details

### Files Modified
```
src/lib/logger.ts                          # Added debug() method
src/services/transaction-api.ts            # Strong typing with DTOs instead of 'any'
src/services/blockchain/blockfrost-service.ts  # Added withdrawal fetching
src/app/api/wallet/route.ts                # Balance calculation logic
src/workers/sync-worker.ts                 # Balance update after sync
```

### Files Created (Testing)
```
local-testing/verify-balance-calculation.ts    # Comprehensive balance verification
local-testing/debug-balance-discrepancy.ts     # Detailed discrepancy analysis
local-testing/test-specific-transaction.ts     # Individual transaction parser test
local-testing/check-sync-status.ts             # Sync status checker
local-testing/test-transactions-api.ts         # API endpoint tester
local-testing/verify-transactions-display.ts   # Database transaction verification
local-testing/create-sync-job.ts               # Manual sync job creation
```

### TypeScript Type System Improvements
```typescript
// Before (BAD - using 'any')
function validateTransaction(tx: any): WalletTransaction

// After (GOOD - strong typing with DTOs)
interface TransactionDTO {
  id: string;
  wallet_address: string;
  tx_hash: string;
  tx_timestamp: string;
  action: string;
  net_ada_change: string;
  fees: string;
  block_height: number;
  // ... complete type definition
}

function transformTransaction(dto: TransactionDTO): WalletTransaction
```

### Database Schema Clarifications
- Column is `timestamp` NOT `tx_timestamp` in wallet_transactions table
- `balance_lovelace` in wallets table is outdated (5884 ADA from August)
- Need to update balance cache after sync operations

## 3. Testing Strategy

### Available Test Scripts
```bash
# Verify balance calculation
npx tsx local-testing/verify-balance-calculation.ts

# Debug specific discrepancy
npx tsx local-testing/debug-balance-discrepancy.ts  

# Test individual transaction
npx tsx local-testing/test-specific-transaction.ts

# Check sync status
npx tsx local-testing/check-sync-status.ts

# Test API responses
npx tsx local-testing/test-transactions-api.ts

# Verify DB transactions
npx tsx local-testing/verify-transactions-display.ts

# Manual sync operations
npx tsx local-testing/create-sync-job.ts
npx tsx local-testing/test-incremental-sync.ts

# Test Blockfrost connection
npx tsx local-testing/test-blockfrost-connection.ts
```

### Test Results
- ‚úÖ Transaction parsing: -4.598119 ADA matches Blockfrost exactly
- ‚úÖ All 72 transactions present in database
- ‚úÖ Sync worker processes jobs correctly
- ‚úÖ API returns 200 OK with transaction data
- ‚ùå 7.23 ADA discrepancy remains unexplained
- ‚ùå Staking withdrawals not included in balance

## 4. Guidelines & Best Practices

### TypeScript Patterns
1. **NEVER use `any`** - Define proper interfaces/types
2. **Use DTOs for API responses** - TransactionDTO, AssetFlowDTO, etc.
3. **Transform at boundaries** - Convert snake_case to camelCase explicitly
4. **Type guards for filtering** - `.filter((tx): tx is WalletTransaction => tx !== null)`

### Database Column Naming
- **Reality**: `timestamp` is the actual column name
- **Issue**: `timestamp` is PostgreSQL reserved word but CAN be used as column
- **RPC Functions**: Need prefixes like `tx_timestamp` in RETURN TABLE definitions
- **Consistency**: Pick one naming convention and stick to it

### Error Handling
```typescript
// Good - specific error messages with context
if (!dto.tx_timestamp) {
  throw new Error(`Transaction ${dto.id} missing required timestamp`);
}

// Bad - generic errors
if (!tx.timestamp) {
  throw new Error('Invalid transaction');
}
```

## 5. Lessons Learned

### Critical Discoveries
1. **Blockchain Immutability** - Transactions NEVER change after confirmation
2. **Balance Caching Strategy** - Should cache and increment, not recalculate
3. **Withdrawal Handling** - Must fetch separately via `txsWithdrawals` API
4. **Fee Calculation** - Fees are already included in input/output difference

### Common Pitfalls
- Assuming `tx_timestamp` when column is `timestamp`
- Recalculating entire balance on every request (expensive!)
- Missing staking withdrawals in transaction details
- Using `any` types instead of proper interfaces

### Debugging Techniques
```typescript
// Trace individual transactions
const actualNetChange = walletOutputTotal - walletInputTotal;
console.log(`Actual: ${actualNetChange}, Parsed: ${parsed.netADAChange}`);

// Compare with source of truth
const blockfrostBalance = await api.addresses(wallet);
const ourBalance = await calculateFromTransactions();
console.log(`Discrepancy: ${blockfrostBalance - ourBalance}`);
```

## 6. Recommendations for Next Session

### Priority 1: Fix Balance Calculation
```typescript
// Implement proper incremental balance updates
interface WalletBalance {
  balance_lovelace: bigint;
  last_calculated_block: number;
  last_updated: Date;
}

// Add withdrawals to transaction parsing
if (rawTx.withdrawals?.length > 0) {
  const totalWithdrawals = rawTx.withdrawals.reduce(
    (sum, w) => sum + BigInt(w.amount), 0n
  );
  netADAChange += totalWithdrawals;
}
```

### Priority 2: Optimize Sync Strategy
```typescript
// Full sync for new wallets
async function fullSync(wallet: string) {
  const allTxs = await fetchAllTransactions(wallet);
  const balance = calculateTotalBalance(allTxs);
  await saveBalance(wallet, balance);
}

// Incremental for existing (blockchain is immutable!)
async function incrementalSync(wallet: string, lastBlock: number) {
  const newTxs = await fetchTransactionsSince(wallet, lastBlock);
  const balanceChange = sumChanges(newTxs);
  await updateBalance(wallet, balanceChange); // ADD to existing
}
```

### Priority 3: Database Refresh Script
```typescript
// Create script to reset and resync
async function refreshDatabase() {
  // 1. Clear all transactions
  await supabase.from('wallet_transactions').delete();
  
  // 2. Reset sync status
  await supabase.from('wallet_sync_status').update({
    last_synced_block: 0,
    last_synced_at: null
  });
  
  // 3. Trigger fresh sync
  await createSyncJob(wallet, userId);
}
```

## 7. Context for New AI Agent

### Project Overview
Cardano DeFi wallet tracker that syncs blockchain transactions, calculates balances, and displays portfolio data. Built with Next.js 15, Supabase, and Blockfrost API.

### Critical Architecture Components
```
src/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ blockchain/blockfrost-service.ts  # Blockchain data fetching
‚îÇ   ‚îú‚îÄ‚îÄ wallet-transaction-parser.ts      # Parse raw txs to wallet format
‚îÇ   ‚îú‚îÄ‚îÄ wallet-transaction-filter.ts      # Filter for wallet relevance
‚îÇ   ‚îî‚îÄ‚îÄ transaction-api.ts                # Frontend API service
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îî‚îÄ‚îÄ sync-worker.ts                     # Background sync processing
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ transaction-repository.ts          # Database operations
‚îî‚îÄ‚îÄ app/api/
    ‚îú‚îÄ‚îÄ wallet/route.ts                    # Wallet balance endpoint
    ‚îî‚îÄ‚îÄ transactions/route.ts              # Transaction list endpoint
```

### Environment Variables
```bash
# .env.local
BLOCKFROST_KEY=mainnetXXXXXXXXXXXXXXXXXXXXXXXXXXXX
NEXT_PUBLIC_SUPABASE_URL=https://XXX.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.XXX
```

### Test Wallet
```
Address: addr1q88e4cenkacs32sk9w9dwdncnxyfxxsttfua2lutd7qklwryjz36as5paaj2xk5qet6u93clltzdddcnfm2sf3jtjwsqajl5ln
User ID: c828be33-dacd-462c-9631-588d049eaeb8
Expected Balance: 5021.18 ADA (per Blockfrost)
Current Calculated: 5013.95 ADA (7.23 ADA discrepancy)
```

## 8. Current System Status

### ‚úÖ Working Well
- Sync queue and worker processing
- Transaction parsing (individual tx calculations correct)
- API endpoints returning data
- Database has all 72 transactions
- Incremental sync fetches new transactions

### üîß Needs Fixing
- **Balance Calculation**: Missing 7.23 ADA (likely withdrawals)
- **Wallet Balance Cache**: Shows outdated 5884 ADA
- **Transaction Display**: Frontend not showing transactions properly
- **Staking Withdrawals**: Not included in balance calculation

### üöß Technical Debt
- Remove placeholder portfolio values
- Implement proper balance caching strategy
- Add comprehensive error logging
- Clean up test files (too many duplicates)

## TODO List (Current State)
1. ‚úÖ Fix logger.debug error in cache module
2. ‚úÖ Debug why transactions aren't displaying despite API returning data
3. ‚úÖ Fix ADA balance display (showing 5884 instead of 5021)
4. ‚úÖ Remove placeholder portfolio value - show real value or nothing
5. ‚úÖ Find and fix 7.23 ADA discrepancy in balance calculation
6. ‚è≥ Add staking withdrawal handling to transaction parser
7. ‚è≥ Update wallet balance cache after sync
8. ‚è≥ Test full user flow from login to transaction display

## Next Session Game Plan

### 1. Create Database Refresh Script
```bash
npx tsx local-testing/refresh-database.ts
# - Clear all transactions
# - Reset sync status
# - Trigger fresh sync with new logic
```

### 2. Implement Proper Sync Logic
- Full sync for new wallets (from block 0)
- Incremental sync for existing (from last block)
- Update cached balance incrementally
- Include staking withdrawals

### 3. Fix Frontend Display
- Ensure transactions show in UI
- Display correct balance from cache
- Remove placeholder values
- Add proper error states

### 4. Consolidate Test Files
Instead of creating new test files, use existing:
- `test-blockfrost-connection.ts` - API connectivity
- `test-incremental-sync.ts` - Sync logic
- `verify-balance-calculation.ts` - Balance verification
- `check-sync-status.ts` - System status

### Remember: Blockchain is Immutable!
Once we sync a transaction, it NEVER changes. This means:
- Cache balances and update incrementally
- Never recalculate from scratch after initial sync
- Trust cached data for historical transactions
- Only fetch new transactions going forward

---

**Ready for next session with full context!** üöÄ